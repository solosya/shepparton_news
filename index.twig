{{ set(this, 'title', _Blog.getBlogTitle()) }}
{% set networkData = _Network.getNetworkData() %}
{% set blogData    = _Blog.getBlog() %}
{% set layout      = blogData.layout %}
{% set site        = networkData.title | lower | split(" ")[0]%}

{# {% set site        =  'country' %} #}

{# {% set layoutTitle = _Page.getLayoutTitle() %} #}

{{this.registerJs("Acme.cards = CardController();")}}

{% set templatePath = "window.Acme.templatePath = '" ~ networkData.templatePath ~ "';" %}
{{this.registerJs( templatePath )}}

{# {% set limit = 1 %}
{% set articlesArr = _Blog.getBlogFeed({'limit': limit, 'offset': 0}) %}
{% set articles = articlesArr.articles %} #}


<!-- used to index each article as we loop over throughout the template -->
{# {% set articleCount = _AppHelper.getApplicationEnv() == 'DEV' ? 0 : 0 %} #}
{% set dev = _AppHelper.getApplicationEnv() == 'DEV' ? false : false %}


{# The following list of blogs are required for each site to load the feeds #}
{% set blogFeeds =  {} %}
{% if site | lower == 'shepparton' %}

    {% set blogFeeds = {
            "aapp":             { "limit" : 15},
            "local news":       { "limit" : 6},
            "local sport":      { "limit" : 2}, 
            "regional news":    { "limit" : 5},
            "opinion":          { "limit" : 4},
            "rural news":       { "limit" : 3},
            "sport":            { "limit" : 5},
            "national":         { "limit" : 4},
            "business":         { "limit" : 5},
            "bloggers":         { "limit" : 3}
        }
    %}

    {% set pageSections =  {
        'index': {
            'template': 'partials/index/default-top.twig',
            'blogs'         : ['aapp'],
        },
        'local news': {
            'template': 'partials/index/large-section.twig',
            'title' : 'Local News',
            'blogs': ['local news'],
        },
        'bloggers' :  {
            'template' : 'partials/index/bloggers.twig',
            'blogs': ['bloggers'],
            'template_params' : {
                'logo':  networkData.templatePath ~ '/static/images/megaphone.svg',
            }
        }                   


    } %}


{% endif  %}


{% for key, value in blogFeeds %}
    {% for blog in networkData.networkBlogs %}
        {% if blog.title | lower == key %}
            
            {% set feed = dev 
                    ? articlesArr 
                    : _Blog.getBlogFeed({'limit': blogFeeds[key]['limit'], 'offset': 0, 'blogid':blog.guid}) 
            %}

            {% set blogFeeds = blogFeeds | merge({
                (key) : {
                    'feed'      : feed,
                    'link'      : blog.link,
                    'title'     : blogFeeds[key]['title']
                    }
                }) %}

        {% endif %}
    {% endfor %}
{% endfor %}



{% set sectionCount = 0 %}
{% set sectionOrder = [] %}

{% if site == 'shepparton' %}
    {% set sectionOrder = ['index', 'local news', 'real estate', 'automotive', 'opinion', 'videos', 'galleries', 'regional news', 'rural news'] %}
{% elseif site == 'country' %}
    {% set sectionOrder = ['dairy', 'water', 'horticulture', 'livestock', 'cropping', 'videos', 'blogs homepage', 'viticulture'] %}
{% endif %}











<main id="main" class="site-main" role="main">
    





    {# <div id="newAdSlot"></div>
    <script>loadNextAd()</script> #}










    {# *******************************************************
                           SECTIONS
    ******************************************************* #}
    {% for pagesection in sectionOrder %}

        {% set section = pageSections[pagesection] %}


        {% set count = {} %}

        {% set feedArr = [] %}


        {# If a page section has articles from multiple blogs, assemble here #}
        {% if section.articleOrder is defined and section.articleOrder | length > 0 %}
            
            {% for a in section.articleOrder %}
                
                {% set count = count | merge( { (a) : count[a] + 1 } ) %}

                {% set feedArr = feedArr | merge( { (loop.index0) : blogFeeds[a].feed.articles[ count[a] - 1 ] }) %}
                
            {% endfor %}
        
        {# else if a page section has articles from a single blog, no assembly required #}
        {% else %}

            {% set feedArr = blogFeeds[section.blogs[0]].feed.articles %}

        {% endif %}


        {% if section.template != '' %}
            {% set params = {
                articles: feedArr, 
                title:    section.title is defined ? section.title : '',
                dev:      dev,
                site:     site
            } %}

            {% if section.template_params is defined and section.template_params | length > 0  %}
                {% set params = params | merge(section.template_params) %}
            {% endif %}

            <div class="container">
                {{this.render(section.template, params) | raw}} 
            </div>
        {% endif %}








        {% if loop.index == 1 %}
            <div class="ad-container hidden-md hidden-lg mobad2">
                <div id='div-gpt-ad-mrec-7' class="card__announcement-image google_ad google_ad_mrec text-center" >
                    <script type='text/javascript'>
                        googletag.cmd.push(function() { googletag.display('div-gpt-ad-mrec-7'); });
                    </script>
                </div>
            </div>
        {% endif %}



        {% if loop.index == 3 %}
            <div class="ad-container visible-sm-block">
                <div id='div-gpt-ad-leaderboard-3' class="google_ad google_ad_leaderboard">
                    <script type='text/javascript'>
                        googletag.cmd.push(function() { googletag.display('div-gpt-ad-leaderboard-3'); });
                    </script>
                </div>
            </div>      
        {% endif %}


        {# {{dump(loop.index)}} #}

    {% endfor %}


   






</main><!-- .site-main -->





<div id='div-gpt-ad-interstitial' class="hidden-xs">
    <script type='text/javascript'>
        googletag.cmd.push(function() { googletag.display('div-gpt-ad-interstitial'); });
    </script>
</div>


<div id='div-gpt-ad-teads' class="hidden-xs">
    <script type='text/javascript'>
        googletag.cmd.push(function() { googletag.display('div-gpt-ad-teads'); });
    </script>
</div>