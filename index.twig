{{ set(this, 'title', _Blog.getBlogTitle()) }}
{% set networkData = _Network.getNetworkData() %}
{% set blogData    = _Blog.getBlog() %}
{% set layout      = blogData.layout %}
{% set site        = networkData.title | lower | split(" ")[0]%}
{# {% set site        = 'dairy' %} #}
{% set homeBlog    = blogData['title'] | lower %}


{# {% set layoutTitle = _Page.getLayoutTitle() %} #}

{{this.registerJs("Acme.cards = CardController();")}}

{% set templatePath = "window.Acme.templatePath = '" ~ networkData.templatePath ~ "';" %}
{{this.registerJs( templatePath )}}

{% set dev = _AppHelper.getApplicationEnv() == 'DEV' ? false : false %}

{% set sectionOrder = [] %}







{# *******************************************************
                GLOBAL SITE SECTIONS
              (each site can override)
******************************************************* #}

{% set pageSections =  {
    'index': {
        'template': 'partials/index/section-00-top.twig',
        'template_params' : {
            'ad': 'mrec-2',
        },
        'blogs' : [(homeBlog)],
    },
    'local': {
        'template': 'partials/index/section-01-local.twig',
        'template_params' : {
            'ad': 'mrec-4'
        },
        'title' : 'Local News',
        'blogs': ['local news'],
    },
    "real estate": {
        'title'     : "Real Estate",
        'blogs'     : ['real estate'],
        'background': true,
        'template'  : 'partials/index/section-02-real-estate.twig', 
        'template_params' : {
            'networkData' : networkData
        },
    },
    "automotive": {
        'title'     : "Automotive",
        'blogs'     : ['automotive'],
        'template'  : 'partials/index/section-02-real-estate.twig', 
    },
    "opinion": {
        'title'     : "Opinion",
        'blogs'     : ['opinion'],
        'template'  : 'partials/index/section-03-opinion.twig',
    },
    'bloggers' :  {
        'blogs'     : ['blogs'],
        'template'  : 'partials/index/section-12-bloggers.twig',
        'template_params' : {
            'logo':  networkData.templatePath ~ '/static/images/megaphone.svg',
        }
    },
    "videos": {
        'title'     : "Videos",
        'blogs'     : ['video'],
        'background': true,
        'template'  : 'partials/index/section-04-videos.twig'
    },
    "galleries": {
        'title'     : "Galleries",
        'blogs'     : ['galleries'],
        'template'  : 'partials/index/section-05-gallery.twig'
    },
    "social": {
        'title'     : "Social",
        'blogs'     : ['social'],
        'template'  : 'partials/index/section-06-social.twig'
    },
    "contributed photos": {
        'title'     : "Contributed Photos",
        'blogs'     : ['contributed photos'],
        'template'  : 'partials/index/section-05-gallery.twig'
    }, 
    "regional news": {
        'title'     : "Regional News",
        'blogs'     : ['regional news'],
        'template'  : 'partials/index/section-07-regional.twig', 
        'template_params' : {
            'ad': 'mrec-6'
        }
    },
    "rural news": {
        'title'     : "Rural News",
        'blogs'     : ['rural news'],
        'template'  : 'partials/index/section-08-rural.twig',
        'template_params' : {
            'ad': 'mrec-8'
        }
    },
    "national": {
        'title'     : "National and World",
        'blogs'     : ['national'],
        'template'  : 'partials/index/section-09-national.twig', 
        'template_params' : {
            'ad': 'mrec-9'
        }
    },
    'index-country': {
        'template' : 'partials/index/section-00-top.twig',
        'template_params' : {
            'ad': 'mrec-2',
        },
        'blogs'     : [(homeBlog)]
    },
    'dairy': {
        'title'     : "Dairy",
        'template'  : 'partials/index/section-11-medium.twig',
        'template_params' : {
            'ad': 'mrec-4'
        },
        'blogs'     : ['dairy']
    },
    'water': {
        'title'     : "Water",
        'template'  : 'partials/index/section-13-small.twig',
        'blogs'     : ['water']
    },
    'horticulture': {
        'title'     : "Horticulture",
        'template'  : 'partials/index/section-14-three.twig',
        'blogs'     : ['horticulture']
    },
    'viticulture': {
        'title'     : "Viticulture",
        'template'  : 'partials/index/section-15-three-ad.twig',
        'blogs'     : ['viticulture'],
        'template_params' : {
            'ad': 'mrec-6'
        }
    },
    "livestock": {
        'title'     : "Livestock",
        'blogs'     : ['livestock'],
        'template'  : 'partials/index/section-06-social.twig'
    },
    'cropping': {
        'title'     : "Cropping",
        'template'  : 'partials/index/section-14-three.twig',
        'blogs'     : ['cropping']
    },
    'index-dairy': {
        'template': 'partials/index/section-00-top.twig',
        'blogs'     : [(homeBlog)]
    },
    'management': {
        'title'     : "Management",
        'template'  : 'partials/index/section-11-medium.twig',
        'template_params' : {
            'ad': 'mrec-2'
        },
        'blogs'     : ['management']
    },
    'from the experts': {
        'title'     : "From The Experts",
        'template'  : 'partials/index/section-13-small.twig',
        'blogs'     : ['from the experts']
    },
    'markets': {
        'title'     : "Markets",
        'template'  : 'partials/index/section-14-three.twig',
        'blogs'     : ['markets']
    },
    'machinery & products': {
        'title'     : "Machinery & Products",
        'template'  : 'partials/index/section-15-three-ad.twig',
        'blogs'     : ['machinery & products'],
        'template_params' : {
                'ad': 'mrec-4'
        }
    },
    'animal health': {
        'title'     : "Animal Health",
        'template'  : 'partials/index/section-14-three.twig',
        'blogs'     : ['animal health']
    }
} %}








{# The following list of blogs are required for each site to load the feeds #}

{# *******************************************************
                        SHEPPARTON
******************************************************* #}
{% set blogFeeds =  {} %}

{% if site == 'shepparton' or site == 'aapp' %}

    {% set blogFeeds = blogFeeds | merge({
            (homeBlog):             { "limit" : 15},
            "local news":           { "limit" : 12},
            "opinion":              { "limit" : 4},
            "real estate":          { "limit" : 3},
            "automotive":           { "limit" : 3},
            "video":                { "limit" : 3},
            "galleries":            { "limit" : 3},
            "social":               { "limit" : 3},
            "contributed photos":   { "limit" : 3},
            "regional news":        { "limit" : 13},
            "rural news":           { "limit" : 16},
            "national":             { "limit" : 9}
        })
    %}

    {% set sectionOrder = ['index', 'local', 'real estate', 'automotive', 'opinion', 'videos', 'galleries', 'social', 'contributed photos', 'regional news', 'rural news', 'national'] %}







{# *******************************************************
                    COUNTRY
******************************************************* #}

{% elseif site == 'country' %}

    {% set blogFeeds = blogFeeds | merge({
            (homeBlog):         { "limit" : 15},
            "dairy":            { "limit" : 5},
            "blogs":            { "limit" : 2},
            "water":            { "limit" : 4},
            "horticulture":     { "limit" : 3},
            "viticulture":      { "limit" : 3},
            "livestock":        { "limit" : 3},
            "cropping":         { "limit" : 3}
        })
    %}

    {% set sectionOrder = ['index-country','dairy', 'bloggers', 'water', 'horticulture', 'viticulture', 'livestock', 'cropping'] %}








{# *******************************************************
                    DAIRY
******************************************************* #}

{% elseif site == 'dairy' %}

    {% set blogFeeds = blogFeeds | merge({
            (homeBlog):             { "limit" : 15},
            "management":           { "limit" : 5},
            "from the experts":     { "limit" : 4},
            "markets":              { "limit" : 3},
            "machinery & products": { "limit" : 3},
            "animal health":        { "limit" : 3}
        })
    %}

    {% set sectionOrder = ['index-dairy', 'management', 'from the experts', 'markets', 'machinery & products', 'animal health'] %}

{% endif %}








{# *******************************************************
                Fetch all needed feeds
******************************************************* #}
{% for key, value in blogFeeds %}
    {% for blog in networkData.networkBlogs %}
        {% if blog.title | lower == key %}

            {% set feed = dev 
                    ? articlesArr 
                    : _Blog.getBlogFeed({'limit': blogFeeds[key]['limit'], 'offset': 0, 'blogid':blog.guid}) 
            %}

            {% set blogFeeds = blogFeeds | merge({
                (key) : {
                    'feed'      : feed,
                    'link'      : blog.link
                    }
                }) %}

        {% endif %}
    {% endfor %}
{% endfor %}












<main id="main" class="site-main" role="main">

    {# *******************************************************
                        RENDER SECTIONS
    ******************************************************* #}
    {% for pagesection in sectionOrder %}

        {% set section = pageSections[pagesection] %}


        {% set count = {} %}

        {% set feedArr = [] %}


        {# If a page section has articles from multiple blogs, assemble here #}
        {% if section.articleOrder is defined and section.articleOrder | length > 0 %}
            
            {% for a in section.articleOrder %}
                
                {% set count = count | merge( { (a) : count[a] + 1 } ) %}

                {% set feedArr = feedArr | merge( { (loop.index0) : blogFeeds[a].feed.articles[ count[a] - 1 ] }) %}
                
            {% endfor %}
        
        {# else if a page section has articles from a single blog, no assembly required #}
        {% else %}

            {% set feedArr = blogFeeds[section.blogs[0]].feed.articles %}

        {% endif %}


        {% if section.template != '' %}
            {% set params = {
                articles: feedArr,
                link:     blogFeeds[ section.blogs[0] ].link,
                title:    section.title is defined ? section.title : '',
                dev:      dev,
                site:     site
            } %}

            {% if section.template_params is defined and section.template_params | length > 0  %}
                {% set params = params | merge(section.template_params) %}
            {% endif %}

            {% if section.background %}
                <div class="section-background">
            {% endif %}

                <div class="container">
                    {{this.render(section.template, params) | raw}} 
                </div>

            {% if section.background %}
                </div>
            {% endif %}

        {% endif %}


        {% if site == 'country' %}
            {% if loop.index == 1 %}
                <div class="ad-container mobad9">
                    <div id='banner-3' class='advert'></div>
                </div> 
            {% elseif loop.index == 2 %}
                <div class="ad-container mobad2">
                    <div id='banner-5' class='advert'></div>
                </div> 
            {% elseif loop.index == 6 %}
                <div class="ad-container mobad9">
                    <div id='banner-7' class='advert'></div>
                </div> 
            {% endif %}
            
        {% elseif site == 'dairy' %}
            {% if loop.index == 1 %}
                <div class="ad-container mobad9">
                    <div id='banner-3' class='advert'></div>
                </div> 
            {% elseif loop.index == 3 %}
                <div class="ad-container mobad9">
                    <div id='banner-5' class='advert'></div>
                </div> 
            {% elseif loop.index == 4 %}
                <div class="ad-container mobad9">
                    <div id='banner-7' class='advert'></div>
                </div> 
            {% endif %}
        
        {% else %}

        
            {% if loop.index == 1 %}
                <div class="ad-container mobad9">
                    <div id='banner-3' class='advert'></div>
                </div> 
            {% elseif loop.index == 7 %}
                <div class="ad-container mobad2">
                    <div id='banner-5' class='advert'></div>
                </div> 
            {% elseif loop.index == 10 %}
                <div class="ad-container mobad9">
                    <div id='banner-7' class='advert'></div>
                </div> 
            {% endif %}
        {% endif %}


    {% endfor %}



</main><!-- .site-main -->





<div id='interstitial-ad-desktop-tablet' class='advert hidden-xs'
    data-site="{{site}}"
    data-section="{{blogData.title | lower}}"
    data-type="{{blogData.type | lower}}"        
></div>