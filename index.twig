{{ set(this, 'title', _Blog.getBlogTitle()) }}
{% set networkData = _Network.getNetworkData() %}
{% set blogData    = _Blog.getBlog() %}
{% set layout      = blogData.layout %}
{% set site        = networkData.title | lower | split(" ")[0]%}
{# {% set site        =  'country' %} #}

{# {% set layoutTitle = _Page.getLayoutTitle() %} #}

{{this.registerJs("Acme.cards = CardController();")}}

{% set templatePath = "window.Acme.templatePath = '" ~ networkData.templatePath ~ "';" %}
{{this.registerJs( templatePath )}}

{% set limit = 1 %}

{% set articlesArr = _Blog.getBlogFeed({'limit': limit, 'offset': 0}) %}
{% set articles = articlesArr.articles %}


<!-- used to index each article as we loop over throughout the template -->
{% set articleCount = _AppHelper.getApplicationEnv() == 'DEV' ? 0 : 0 %}
{% set dev = _AppHelper.getApplicationEnv() == 'DEV' ? true : false %}

{% set sectionFeeds =  {} %}

{% if site | lower == 'shepp' %}
    {% set sectionFeeds =  {
            "local news": {
                "title": "Local News",       "limit" : 2
            },
            "local sport": {
                "title": "Local Sport",      "limit" : 2
            }, 

            "regional news": {
                "title": "Regional News",   "limit" : 5, 'template' : 'partials/index/medium-section.twig', 
                    'template_params' : {
                        'ad': 'div-gpt-ad-halfpage-ss'
                    }
            },
            "opinion": {
                "title": "Opinion",         "limit" : 4
            },
            "rural news": {
                "title": "Rural News",      "limit" : 3
            },
            "sport": {
                "title": "Sport",           "limit" : 5
            },
            "national": {
                "title": "National",        "limit" : 4
            },
            "business": {
                "title": "Business",        "limit" : 5
            },
            "bloggers": {
                "title": "Bloggers",        "limit" : 2, 'template' : 'partials/index/bloggers.twig',
                    'template_params' : {
                        'logo':  networkData.templatePath ~ '/static/images/megaphone.svg',
                    }
            }
        }
    %}

    {% set pageSections =  {
        'Top': {
            'template': 'partials/index/default-top.twig',
            'template_params' : {},
            'feeds': ['opinion', 'local news']
        },
        'Local': {
            'template': 'partials/index/large-section.twig',
            'template_params' : {},
            'feeds': ['local news', 'opinion']
        },

    } %}


{% endif  %}


{% for key, value in sectionFeeds %}
    {% for blog in networkData.networkBlogs %}
        {% if blog.title | lower == key %}
            
            {% set feed = dev 
                    ? articlesArr 
                    : _Blog.getBlogFeed({'limit': sectionFeeds[key]['limit'], 'offset': 0, 'blogid':blog.guid}) 
            %}

            {% set sectionFeeds = sectionFeeds | merge({
                (key) : {
                    'feed'      : feed,
                    'link'      : blog.link,
                    'title'     : sectionFeeds[key]['title']
                    }
                }) %}

        {% endif %}
    {% endfor %}
{% endfor %}




{% set sectionCount = 0 %}
{% set sectionOrder = [] %}

{% if site == 'shepp' %}
    {% set sectionOrder = ['local news', 'bloggers', 'regional news', 'opinion', 'rural news', 'sport'] %}
{% elseif site == 'country' %}
    {% set sectionOrder = ['dairy', 'water', 'horticulture', 'livestock', 'cropping', 'videos', 'blogs homepage', 'viticulture'] %}
{% endif %}











<main id="main" class="site-main" role="main">
    


    {# *******************************************************
                Top of Index page n articles
    ******************************************************* #}

    {# <div class="container">
        {{this.render('partials/index/default-top.twig', {
            articles: articles, 
            articleCount: articleCount,
            dev: dev,
            site: site,
            ad: 'div-gpt-ad-mrec-4',
        }) | raw}}
    </div>
 #}




    {# <div id="newAdSlot"></div>
    <script>loadNextAd()</script> #}










    {# *******************************************************
                           SECTIONS
    ******************************************************* #}

    {% for title, section in pageSections %}
       
        {% set feedArr = {} %}
        
        {% for feed in section.feeds %}

            {% set feedArr = feedArr | merge({
                 (feed) : sectionFeeds[feed] 
            }) %}
        {% endfor %}


        {% if section.template != '' %}
            {% set params = {
                articles: feedArr, 
                title:    title,
                dev:      dev,
                site:     site
            } %}

            {% if section.template_params | length > 0  %}
                {% set params = params | merge(section.template_params) %}
            {% endif %}

            <div class="container">
                {{this.render(section.template, params) | raw}} 
            </div>
        {% endif %}


        {% if loop.index == 1 %}
            <div class="ad-container hidden-md hidden-lg mobad2">
                <div id='div-gpt-ad-mrec-7' class="card__announcement-image google_ad google_ad_mrec text-center" >
                    <script type='text/javascript'>
                        googletag.cmd.push(function() { googletag.display('div-gpt-ad-mrec-7'); });
                    </script>
                </div>
            </div>
        {% endif %}

        {% if loop.index == 3 %}
            <div class="ad-container visible-sm-block">
                <div id='div-gpt-ad-leaderboard-3' class="google_ad google_ad_leaderboard">
                    <script type='text/javascript'>
                        googletag.cmd.push(function() { googletag.display('div-gpt-ad-leaderboard-3'); });
                    </script>
                </div>
            </div>      
        {% endif %}


        {# {{dump(loop.index)}} #}

    {% endfor %}


   






</main><!-- .site-main -->





<div id='div-gpt-ad-interstitial' class="hidden-xs">
    <script type='text/javascript'>
        googletag.cmd.push(function() { googletag.display('div-gpt-ad-interstitial'); });
    </script>
</div>


<div id='div-gpt-ad-teads' class="hidden-xs">
    <script type='text/javascript'>
        googletag.cmd.push(function() { googletag.display('div-gpt-ad-teads'); });
    </script>
</div>